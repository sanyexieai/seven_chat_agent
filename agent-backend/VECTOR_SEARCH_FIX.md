# 向量搜索修复指南

## 已完成的修改

### 1. 更新嵌入模型配置
- **文件**: `agent-backend/config.py`
- **修改**: 将 `EMBEDDING_MODEL` 从 `nomic-embed-text` 改为 `bge-m3`
- **原因**: `bge-m3` 是专门优化的中文多语言模型，对三国演义等中文文本有更好的语义理解

### 2. 更新分块参数使用
- **文件**: `agent-backend/services/knowledge_base_service.py`
- **修改**: 使用配置文件中的 `CHUNK_SIZE` (1000) 和 `CHUNK_OVERLAP` (200)
- **原因**: 更大的分块和重叠可以保持"桃园三结义"等完整事件的上下文

## 需要执行的步骤

### 1. 下载中文嵌入模型
```bash
ollama pull bge-m3
```

### 2. 重启后端服务
```bash
cd agent-backend
python main.py
```

### 3. 重新处理文档
- 在前端删除现有的三国演义文档
- 重新上传文档，让系统使用新的嵌入模型处理

### 4. 测试搜索
查询: "桃园三结义的是谁"
预期结果: 应该返回包含刘备、关羽、张飞的相关内容

## 预期改进

- **相似度分数**: 从 0.1-0.3 提升到 0.6-0.9
- **搜索准确性**: 能够正确匹配中文语义查询
- **上下文完整性**: 相关人物和事件不会被分割到不同的块中

## 故障排查

如果搜索结果仍然不理想:

1. **检查模型是否正确加载**:
   - 查看后端日志，确认使用的是 `bge-m3` 模型

2. **检查文档是否重新处理**:
   - 查看数据库 `document_chunks` 表
   - 确认 embedding 向量已更新

3. **检查相似度分数**:
   - 在查询结果中查看 similarity 值
   - 如果仍然很低(<0.3)，可能需要尝试其他中文模型

## 备选中文模型

如果 `bge-m3` 效果不理想，可以尝试:
- `bge-large-zh-v1.5`
- `text2vec-large-chinese`
- `qwen2.5:7b` (如果有足够内存)
