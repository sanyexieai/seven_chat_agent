# 分层分割和多跳关系查询实现总结

## 概述

本次实现完成了两个重要功能：
1. **智能分层文本分割策略** - 根据文档结构进行智能分块
2. **多跳关系查询支持** - 在知识图谱中进行深度关系推理

## 1. 分层分割策略

### 设计思路

按照用户提出的设计思路，实现了分层分割策略：

1. **步骤1：预处理文档，提取结构**
   - 检测章节标题模式（第X章、1.标题、一、标题等）
   - 识别Markdown标题格式

2. **步骤2：按章节分割**
   - 如果检测到文档结构，按章节进行分割
   - 每个章节独立处理

3. **步骤3：按段落分割**
   - 对每个章节按段落进一步分割
   - 移除最小长度限制，让分层策略处理

4. **步骤4：句子分割和合并**
   - 对过长段落按句子分割
   - 使用滑动窗口合并到合适长度

5. **步骤5：后处理**
   - 合并过短的分块
   - 分割过长的分块
   - 使用滑动窗口作为后备策略

### 关键参数

```python
chunk_size=500,      # 目标分块大小
overlap=50,          # 重叠长度
min_chunk_size=100,  # 最小分块大小
max_chunk_size=800,  # 最大分块大小
```

### 支持的分割策略

- `hierarchical`: 分层分割（默认）
- `semantic`: 语义分割
- `sentence`: 句子分割
- `fixed`: 固定长度分割

### 配置选项

```bash
CHUNK_STRATEGY=hierarchical  # 分割策略
USE_LLM_MERGE=false          # 是否使用LLM优化分块
```

## 2. 多跳关系查询

### 功能特点

1. **多跳搜索算法**
   - 从查询相关的直接三元组开始
   - 通过实体关联进行多跳扩展
   - 可配置最大跳数（默认2跳）

2. **智能去重**
   - 避免重复三元组
   - 按置信度和跳数排序

3. **实体关联**
   - 通过主语和宾语进行实体关联
   - 支持双向关系查询

### 配置选项

```bash
KNOWLEDGE_GRAPH_ENABLED=true  # 启用知识图谱
MULTI_HOP_MAX_HOPS=2         # 最大跳数
```

### 查询流程

1. **直接搜索**: 找到与查询直接相关的三元组
2. **实体收集**: 收集所有相关实体
3. **多跳扩展**: 通过实体关联进行多跳搜索
4. **结果排序**: 按跳数和置信度排序
5. **上下文构建**: 将关系信息整合到响应中

## 3. 混合知识库架构

### 模式一：纯向量搜索
- 文档分块 + 向量化存储
- 基于相似度的检索
- LLM生成回答

### 模式二：混合模式（向量 + 图谱）
- 向量搜索找到相关文档
- 多跳关系查询找到相关实体
- 结合文档内容和关系信息生成回答

## 4. 使用示例

### 环境变量配置

```bash
# 分割策略
CHUNK_STRATEGY=hierarchical

# 知识图谱功能
EXTRACT_TRIPLES_ENABLED=true
KNOWLEDGE_GRAPH_ENABLED=true
MULTI_HOP_MAX_HOPS=2

# LLM优化（可选）
USE_LLM_MERGE=false
```

### API调用

```python
# 查询知识库
result = knowledge_base_service.query_knowledge_base(
    kb_id=1,
    query="人工智能的发展历程",
    max_results=5
)

# 结果包含：
# - response: LLM生成的回答
# - sources: 相关文档片段
# - 关系信息: 多跳查询的三元组
```

## 5. 性能优化

### 分层分割优化
- 优先使用文档结构进行分割
- 智能合并过短分块
- 滑动窗口处理长文本

### 多跳查询优化
- 限制每跳的查询数量
- 智能去重避免重复计算
- 按相关性排序结果

### 数据库优化
- 使用索引加速三元组查询
- 批量处理减少数据库访问
- 缓存常用查询结果

## 6. 扩展性

### 分割策略扩展
- 可添加新的分割策略
- 支持自定义分割参数
- 预留LLM优化接口

### 关系查询扩展
- 支持更复杂的图查询语言
- 可添加关系权重计算
- 支持时序关系查询

## 7. 测试验证

### 分层分割测试
- 有结构文档：按章节分割
- 无结构文档：按段落分割
- 长段落：按句子分割

### 多跳查询测试
- 直接关系查询
- 多跳关系推理
- 实体关联分析

## 8. 总结

本次实现完成了用户提出的分层分割策略和多跳关系查询功能，为知识库系统提供了更智能的文档处理和更深入的关系推理能力。系统现在能够：

1. **智能分割文档**：根据文档结构进行分层分割
2. **深度关系推理**：通过多跳查询发现隐藏关系
3. **混合搜索模式**：结合向量搜索和图谱推理
4. **灵活配置**：支持多种分割策略和查询参数

这些功能大大提升了知识库系统的智能化水平和查询效果。
