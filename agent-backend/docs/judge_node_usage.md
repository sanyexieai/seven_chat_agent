# 判断节点使用说明

## 概述

判断节点（Judge Node）是流程图驱动智能体中的一个新节点类型，用于在流程执行过程中进行智能判断，决定下一步的执行路径。它替代了之前硬编码的判断逻辑，使流程图更加灵活和可配置。

## 节点类型

判断节点现在支持多种预定义的判断类型，每种类型都有相应的默认提示词和分支逻辑：

### 1. 自定义判断（custom）

最灵活的判断类型，用户可以完全自定义提示词和逻辑。

### 2. 直接回答判断（direct_answer）

用于判断是否可以在不查询外部数据、工具或知识库的前提下给出可靠回答。

#### 配置参数

- **judge_type**: 判断类型，支持多种预定义类型
- **system_prompt**: 系统提示词（可选，根据类型自动设置默认值）
- **user_prompt**: 用户提示词（可选，根据类型自动设置默认值）
- **save_as**: 保存结果的变量名（默认：`"judge_result"`）

#### 支持的判断类型

1. **custom**: 自定义判断（最灵活）
2. **direct_answer**: 直接回答判断
3. **domain_classification**: 领域分类判断
4. **tool_selection**: 工具选择判断
5. **intent_recognition**: 意图识别判断

#### 默认提示词

每种判断类型都有相应的默认提示词，如果不配置自定义提示词，系统会自动使用：

**1. 直接回答判断（direct_answer）**
- 系统提示词：判断是否可以直接回答
- 用户提示词：输出 `{"can_direct_answer": true|false, "answer": string}`

**2. 领域分类判断（domain_classification）**
- 系统提示词：专业问题分类器
- 用户提示词：输出 `{"domain": "技术|生活|工作|其他", "can_handle": true|false, "reason": "分类原因"}`

**3. 工具选择判断（tool_selection）**
- 系统提示词：工具选择器
- 用户提示词：输出 `{"selected_tool": "工具名", "confidence": 0.0-1.0, "reason": "选择原因"}`

**4. 意图识别判断（intent_recognition）**
- 系统提示词：意图识别器
- 用户提示词：输出 `{"intent": "查询|操作|建议|其他", "priority": "high|medium|low", "requires_tool": true|false}`

**5. 自定义判断（custom）**
- 系统提示词：智能判断器
- 用户提示词：通用判断要求

#### 输出格式

判断节点会输出JSON格式的结果：

```json
{
  "can_direct_answer": true,
  "answer": "这是一个可以直接回答的问题，因为..."
}
```

或

```json
{
  "can_direct_answer": false,
  "answer": "这个问题需要查询外部信息..."
}
```

## 使用方法

### 1. 在流程图中添加判断节点

1. 在流程图编辑器中点击"判断节点"按钮
2. 将节点拖拽到合适的位置
3. 配置节点参数

**重要：判断节点有两个输出端口**
- 左侧绿色端口：连接到"可以直接回答"的处理路径
- 右侧橙色端口：连接到"需要工具"的处理路径

**连接步骤：**
1. 从判断节点的绿色端口拖拽连接到直接回答节点
2. 从判断节点的橙色端口拖拽连接到工具调用节点
3. 两个分支最终都连接到同一个汇总节点

### 2. 配置判断节点

1. 双击判断节点打开配置对话框
2. 选择判断类型（目前支持 `direct_answer`）
3. 可选：自定义系统提示词和用户提示词
4. 设置保存结果的变量名
5. 保存配置

### 3. 连接节点

- 判断节点通常作为起始节点或流程中的决策点
- **判断节点有两个输出端口**：
  - **第一个端口（绿色）**：用于"可以直接回答"的情况
  - **第二个端口（橙色）**：用于"需要工具或外部信息"的情况
- 根据判断结果，系统会自动选择相应的分支执行
- 支持条件分支，实现复杂的流程控制

## 示例流程图

参考 `examples/flow_with_judge_node.json` 文件，这是一个完整的示例流程图，展示了如何使用判断节点。

### 流程图结构

```
[判断节点] (起始节点)
    ├── 绿色端口 → [LLM节点] → [最终回答节点]
    └── 橙色端口 → [工具节点] → [最终回答节点]
```

**关键点：**
- 判断节点有两个输出端口，分别对应不同的执行路径
- 系统根据判断结果自动选择分支
- 两个分支最终都会汇聚到最终回答节点

### 流程说明

1. **判断节点**：判断是否可以直接回答用户问题
   - 如果可以直接回答：走第一个分支（绿色端口）→ LLM节点
   - 如果需要外部信息：走第二个分支（橙色端口）→ 工具节点
2. **LLM节点**：处理可以直接回答的问题
3. **工具节点**：调用外部工具获取信息
4. **最终回答节点**：综合所有结果，生成最终回答

## 高级用法

### 1. 自定义判断逻辑

通过配置自定义的 `system_prompt` 和 `user_prompt`，可以实现各种复杂的判断逻辑：

```json
{
  "judge_type": "direct_answer",
  "system_prompt": "你是一个专业的问题分类器，请判断用户问题属于哪个领域。",
  "user_prompt": "请输出JSON：{\"domain\": \"技术|生活|工作|其他\", \"can_handle\": true|false, \"reason\": \"分类原因\"}",
  "save_as": "domain_classification"
}
```

### 2. 双分支流程控制

判断节点采用双分支设计，根据判断结果自动选择执行路径：

```
判断节点
    ├── 绿色端口（直接回答） → 节点A
    └── 橙色端口（需要工具） → 节点B
```

**分支选择逻辑：**

每种判断类型都有相应的分支选择逻辑：

1. **直接回答判断**：
   - 第一个分支：`can_direct_answer = true`（可以直接回答）
   - 第二个分支：`can_direct_answer = false`（需要工具）

2. **领域分类判断**：
   - 第一个分支：`can_handle = true`（可以处理）
   - 第二个分支：`can_handle = false`（无法处理）

3. **工具选择判断**：
   - 第一个分支：`confidence > 0.7`（高置信度工具）
   - 第二个分支：`confidence ≤ 0.7`（备选工具）

4. **意图识别判断**：
   - 第一个分支：`requires_tool = false`（无需工具）
   - 第二个分支：`requires_tool = true`（需要工具）

5. **自定义判断**：
   - 默认走第一个分支

**优势：**
- 清晰的视觉表示：绿色表示"是"，橙色表示"否"
- 自动路由：系统根据判断结果自动选择分支
- 易于理解：两个分支对应两种不同的处理策略

### 3. 流程状态管理

判断结果会自动保存到流程状态中，可以在后续节点中使用：

- `{judge_result}`: 完整的判断结果
- `{judge_result.can_direct_answer}`: 是否可以直接回答
- `{judge_result.answer}`: 判断的答案

## 注意事项

1. **JSON格式要求**：判断节点的输出必须是有效的JSON格式
2. **错误处理**：如果判断节点执行失败，流程会继续执行下一个节点
3. **性能考虑**：判断节点会调用LLM，建议合理配置以避免不必要的延迟
4. **模板变量**：提示词中支持使用 `{message}`、`{last_output}` 等模板变量

## 扩展计划

未来版本计划支持更多判断类型：

- **工具选择判断**：自动选择最合适的工具
- **知识库查询判断**：判断是否需要查询知识库
- **用户意图识别**：识别用户的真实意图和需求
- **多轮对话判断**：判断是否需要多轮交互

## 故障排除

### 常见问题

1. **判断节点无输出**：检查LLM配置是否正确
2. **JSON解析失败**：确保提示词要求输出正确的JSON格式
3. **流程卡住**：检查节点连接是否正确配置

### 调试技巧

1. 查看流程执行日志
2. 检查判断节点的输出内容
3. 验证JSON格式是否正确
4. 确认LLM配置和权限 