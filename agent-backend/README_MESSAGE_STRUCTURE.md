# 消息数据结构说明

## 概述

新的消息数据结构采用混合设计：
1. **后台存储**：节点直接包含 `content` 字段，存储最终完整内容
2. **前端流式渲染**：前端在流式过程中维护 `chunk_list` 数组，用于实时显示
3. **数据分离**：后台不存储分片数据，前端分片仅用于流式显示

## 数据库表结构

### message_nodes 表
- `id`: 主键
- `node_id`: 节点唯一标识
- `message_id`: 关联的消息ID
- `node_type`: 节点类型 (llm, tool, router等)
- `node_name`: 节点名称
- `node_label`: 节点标签
- `content`: 节点输出内容（可选）
- `node_metadata`: 节点元数据
- `created_at`: 创建时间

### 前端分片数据结构（不存储到数据库）
- `chunk_id`: 片段唯一标识
- `content`: 片段内容
- `chunk_type`: 片段类型 (content, node_complete等)
- `timestamp`: 创建时间戳

## API响应格式

### 消息查询接口返回格式

```json
[
  {
    "id": 1,
    "message_id": "agent_1756178459453_83i5nvrl3",
    "session_id": "session_uuid",
    "user_id": "user_id",
    "message_type": "agent",  // user 或 agent
    "content": "消息级别的完整内容",  // 可选字段，如果存在则优先使用
    "agent_name": "agent_name",
    "metadata": {},
    "created_at": "2025-01-26T10:30:00",
    "nodes": [  // 可选字段，如果存在则包含节点详情
      {
        "id": 1,
        "node_id": "start_llm",
        "node_type": "llm",
        "node_name": "开始判断",
        "node_label": "开始判断",
        "content": "节点级别的完整内容",  // 可选字段
        "node_metadata": {},
        "created_at": "2025-01-26T10:30:00"
      }
    ]
  }
]
```

## 渲染逻辑

前端渲染时按以下优先级处理：

### 消息级别
1. **优先使用消息 `content` 字段**：如果消息有完整内容，直接渲染
2. **回退到节点详情**：如果没有消息内容，则查找节点信息

### 节点级别
1. **优先使用节点 `content` 字段**：如果节点有后台存储的完整内容，直接渲染
2. **回退到前端 `chunk_list`**：如果没有后台内容，则组合前端流式分片内容
3. **显示提示信息**：如果两者都没有，显示"暂无内容"

**注意**：前端分片数据仅在流式过程中临时存在，不会持久化到数据库

## 使用场景

### 消息级别内容
适用于：
- 用户发送的简单消息
- 智能体的简单回复
- 不需要节点分解的响应

### 节点级别内容
适用于：
- 复杂的流程图执行结果
- 需要分步骤显示的内容
- 工具调用的详细结果

### 前端分片格式（流式显示）
适用于：
- 流式响应过程中的实时显示
- 需要逐步显示的内容
- 复杂的多步骤输出
- **注意**：分片数据不存储到数据库，仅用于前端流式渲染

## 数据库结构

当前设计不需要额外的数据库表，因为：

1. **后台存储**：使用现有的 `message_nodes` 表，通过 `content` 字段存储完整内容
2. **前端分片**：分片数据仅在内存中维护，不持久化到数据库
3. **数据一致性**：流式完成后，最终内容会保存到节点的 `content` 字段

## 注意事项

1. **数据优先级**：后台 `content` 字段优先级高于前端 `chunk_list`
2. **分片管理**：前端分片数据仅在流式过程中存在，刷新页面后会丢失
3. **数据一致性**：流式完成后，最终内容会保存到后台，确保数据持久化
4. **性能考虑**：不需要额外的数据库查询，减少了数据库负载
5. **存储效率**：避免了分片数据的重复存储，节省存储空间 